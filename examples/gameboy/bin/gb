#!/usr/bin/env ruby
# frozen_string_literal: true

# Game Boy HDL CLI Emulator
# Runs the Game Boy HDL component with cycle-accurate simulation

require 'optparse'

$LOAD_PATH.unshift File.expand_path('../../../lib', __dir__)
$LOAD_PATH.unshift File.expand_path('../utilities', __dir__)

require 'rhdl'
require 'tasks'

# Alias for backwards compatibility and cleaner top-level access
GameBoyCli = RHDL::GameBoy::Tasks::CliTask

# Only run CLI when executed directly (not when required/loaded for testing)
if __FILE__ == $0 || __FILE__ == $PROGRAM_NAME
  options = {
    speed: 100,
    debug: false,
    dmg_colors: true,
    demo: false,
    pop: false,
    audio: false,
    mode: :hdl,
    sim: :compile,
    renderer: :color
  }

  parser = OptionParser.new do |opts|
    opts.banner = "Usage: bin/gb [options] [rom.gb]"
    opts.separator ""
    opts.separator "Game Boy HDL CLI Emulator - Cycle-accurate simulation"
    opts.separator ""

    opts.on("-m", "--mode TYPE", [:hdl, :verilog],
            "Simulation mode: hdl (default), verilog (Verilator RTL)") do |v|
      options[:mode] = v
    end

    opts.on("--sim TYPE", [:ruby, :interpret, :jit, :compile],
            "Simulator backend: ruby, interpret, jit, compile (default)") do |v|
      options[:sim] = v
    end

    opts.on("--color", "Use color renderer (default)") do
      options[:renderer] = :color
    end

    opts.on("--braille", "Use braille renderer") do
      options[:renderer] = :braille
    end

    opts.on("-s", "--speed CYCLES", Integer, "Cycles per frame (default: 100)") do |v|
      options[:speed] = v
    end

    opts.on("-d", "--debug", "Show CPU state") do
      options[:debug] = true
    end

    opts.on("-g", "--green", "DMG green palette (default)") do
      options[:dmg_colors] = true
    end

    opts.on("-A", "--audio", "Enable audio output") do
      options[:audio] = true
    end

    opts.on("--demo", "Run built-in demo") do
      options[:demo] = true
    end

    opts.on("--pop", "Load Prince of Persia ROM") do
      options[:pop] = true
    end

    opts.on("--lcd-width WIDTH", Integer, "LCD display width in chars (default: 80)") do |v|
      options[:lcd_width] = v
    end

    opts.on("-h", "--help", "Show help") do
      puts opts
      exit
    end
  end

  parser.parse!(ARGV)

  cli = RHDL::GameBoy::Tasks::CliTask.new(options)

  # Load ROM
  rom_file = ARGV.shift
  if rom_file
    unless File.exist?(rom_file)
      puts "Error: ROM file not found: #{rom_file}"
      exit 1
    end
    cli.load_rom(rom_file)
  elsif options[:pop]
    pop_rom = File.expand_path('../software/roms/pop.gb', __dir__)
    if File.exist?(pop_rom)
      puts "Loading Prince of Persia..."
      cli.load_rom(pop_rom)
    else
      puts "Error: Prince of Persia ROM not found: #{pop_rom}"
      exit 1
    end
  elsif options[:demo]
    puts "Loading demo ROM..."
    demo_rom = RHDL::GameBoy::Tasks::DemoRom.new.create
    cli.runner.load_rom(demo_rom)
  else
    puts parser
    puts ""
    puts "Error: No ROM specified. Use --demo, --pop, or provide a ROM file."
    exit 1
  end

  cli.run
end
